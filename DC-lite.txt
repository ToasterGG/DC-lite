<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Discord Lite+</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    body {
      background-color: #202225;
      color: #ffffff;
      height: 100vh;
      overflow: hidden;
    }

    #app {
      display: flex;
      height: 100vh;
      width: 100vw;
    }

    /* Sidebar */
    #sidebar {
      width: 260px;
      background-color: #2b2d31;
      display: flex;
      flex-direction: column;
    }

    #sidebar-inner {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 8px;
      gap: 10px;
    }

    .sidebar-section-title {
      font-size: 12px;
      text-transform: uppercase;
      color: #b9bbbe;
      margin-bottom: 4px;
    }

    .channel,
    .friend {
      padding: 4px 6px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
      color: #dcddde;
    }

    .channel:hover,
    .friend:hover {
      background-color: #3a3c43;
    }

    #friends-list {
      max-height: 160px;
      overflow-y: auto;
    }

    #add-friend-row {
      display: flex;
      gap: 4px;
      margin-top: 4px;
    }

    #add-friend-input {
      flex: 1;
      padding: 4px;
      border-radius: 3px;
      border: none;
      outline: none;
      background-color: #202225;
      color: #ffffff;
      font-size: 13px;
    }

    #add-friend-button {
      padding: 4px 8px;
      border-radius: 3px;
      border: none;
      background-color: #5865f2;
      color: #ffffff;
      font-size: 12px;
      cursor: pointer;
    }

    #add-friend-button:hover {
      background-color: #4752c4;
    }

    /* User bar bottom-left */
    #user-bar {
      padding: 6px 8px;
      background-color: #232428;
      border-top: 1px solid #1e1f22;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #user-pfp {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background-color: #3a3c43;
      object-fit: cover;
      flex-shrink: 0;
    }

    #user-name {
      flex: 1;
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #settings-icon {
      width: 22px;
      height: 22px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #b9bbbe;
      flex-shrink: 0;
    }

    #settings-icon:hover {
      background-color: #3a3c43;
      color: #ffffff;
    }

    /* Main area */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: #313338;
    }

    #header {
      height: 40px;
      border-bottom: 1px solid #202225;
      display: flex;
      align-items: center;
      padding: 0 10px;
      font-size: 15px;
      font-weight: 600;
    }

    #messages {
      flex: 1;
      padding: 8px 10px;
      overflow-y: auto;
      font-size: 14px;
    }

    .message-row {
      display: flex;
      align-items: flex-start;
      margin-bottom: 4px;
      gap: 6px;
    }

    .message-pfp {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: #3a3c43;
      object-fit: cover;
      flex-shrink: 0;
    }

    .message-content {
      display: inline-block;
    }

    .message-username {
      font-weight: 600;
      margin-right: 4px;
      color: #ffffff;
    }

    .message-text {
      color: #dcddde;
    }

    #input-bar {
      border-top: 1px solid #202225;
      padding: 8px 10px;
      display: flex;
      gap: 6px;
    }

    #message-input {
      flex: 1;
      padding: 6px;
      border-radius: 3px;
      border: none;
      outline: none;
      background-color: #383a40;
      color: #ffffff;
      font-size: 14px;
    }

    #send-button {
      padding: 6px 12px;
      border-radius: 3px;
      border: none;
      background-color: #5865f2;
      color: #ffffff;
      font-size: 13px;
      cursor: pointer;
      flex-shrink: 0;
    }

    #send-button:hover {
      background-color: #4752c4;
    }

    /* Login overlay */
    #login-overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 900;
    }

    #login-box {
      width: 280px;
      background-color: #2b2d31;
      border-radius: 6px;
      padding: 16px;
      box-shadow: 0 0 0 1px #202225;
    }

    #login-box h2 {
      font-size: 18px;
      margin-bottom: 10px;
      text-align: center;
    }

    .login-field {
      margin-bottom: 8px;
    }

    .login-field label {
      display: block;
      font-size: 12px;
      margin-bottom: 2px;
      color: #b9bbbe;
    }

    .login-field input {
      width: 100%;
      padding: 6px;
      border-radius: 3px;
      border: none;
      outline: none;
      background-color: #202225;
      color: #ffffff;
      font-size: 13px;
    }

    #login-button {
      width: 100%;
      padding: 7px;
      border-radius: 3px;
      border: none;
      background-color: #5865f2;
      color: #ffffff;
      font-size: 13px;
      cursor: pointer;
      margin-top: 4px;
    }

    #login-button:hover {
      background-color: #4752c4;
    }

    /* Settings modal */
    #settings-overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    #settings-modal {
      width: 360px;
      max-width: 90%;
      background-color: #2b2d31;
      border-radius: 8px;
      padding: 14px 16px 16px;
      box-shadow: 0 0 0 1px #202225;
    }

    #settings-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    #settings-modal-header h2 {
      font-size: 16px;
    }

    #settings-close {
      cursor: pointer;
      font-size: 18px;
      color: #b9bbbe;
    }

    #settings-close:hover {
      color: #ffffff;
    }

    .settings-section {
      margin-bottom: 10px;
    }

    .settings-section label {
      display: block;
      font-size: 12px;
      margin-bottom: 3px;
      color: #b9bbbe;
    }

    .settings-section input[type="file"],
    .settings-section input[type="color"],
    .settings-section select {
      width: 100%;
      padding: 5px;
      border-radius: 3px;
      border: none;
      background-color: #202225;
      color: #ffffff;
      font-size: 12px;
    }

    #settings-save {
      width: 100%;
      padding: 7px;
      border-radius: 3px;
      border: none;
      background-color: #5865f2;
      color: #ffffff;
      font-size: 13px;
      cursor: pointer;
      margin-top: 4px;
    }

    #settings-save:hover {
      background-color: #4752c4;
    }

    /* Watermark */
    #watermark {
      position: fixed;
      right: 8px;
      bottom: 4px;
      font-size: 11px;
      color: #b9bbbe;
      z-index: 10;
    }

    /* Scrollbars */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #2b2d31;
    }
    ::-webkit-scrollbar-thumb {
      background: #202225;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #18191c;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="sidebar">
      <div id="sidebar-inner">
        <div>
          <div class="sidebar-section-title">Channels</div>
          <div class="channel" data-channel="general">#general</div>
          <div class="channel" data-channel="gaming">#gaming</div>
          <div class="channel" data-channel="random">#random</div>
        </div>

        <div>
          <div class="sidebar-section-title" style="margin-top:8px;">Friends / DMs</div>
          <div id="friends-list">
            <!-- friends will be listed here -->
          </div>
          <div id="add-friend-row">
            <input id="add-friend-input" placeholder="Add friend by name">
            <button id="add-friend-button">Add</button>
          </div>
        </div>
      </div>

      <div id="user-bar">
        <img id="user-pfp" src="" alt="PFP">
        <div id="user-name">User</div>
        <div id="settings-icon" title="Settings">âš™</div>
      </div>
    </div>

    <div id="main">
      <div id="header">#general</div>
      <div id="messages"></div>
      <div id="input-bar">
        <input id="message-input" type="text" placeholder="Type a message...">
        <button id="send-button">Send</button>
      </div>
    </div>
  </div>

  <!-- Login overlay -->
  <div id="login-overlay">
    <div id="login-box">
      <h2>Sign in</h2>
      <div class="login-field">
        <label for="login-username">Username</label>
        <input id="login-username" type="text">
      </div>
      <div class="login-field">
        <label for="login-password">Password</label>
        <input id="login-password" type="password">
      </div>
      <button id="login-button">Login / Register</button>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="settings-overlay">
    <div id="settings-modal">
      <div id="settings-modal-header">
        <h2>User Settings</h2>
        <div id="settings-close">&times;</div>
      </div>

      <div class="settings-section">
        <label for="pfp-input">Profile picture</label>
        <input type="file" id="pfp-input" accept="image/*">
      </div>

      <div class="settings-section">
        <label for="bg-picker">Background colour</label>
        <input type="color" id="bg-picker">
      </div>

      <div class="settings-section">
        <label for="dm-pref">DM preferences</label>
        <select id="dm-pref">
          <option value="on">DMs On</option>
          <option value="request">DM Requests Only</option>
          <option value="off">DMs Off</option>
        </select>
      </div>

      <button id="settings-save">Save</button>
    </div>
  </div>

  <div id="watermark">made by Toby Ulliott</div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // Firebase config (v8)
    const firebaseConfig = {
      apiKey: "AIzaSyAcHjp8HQfqNTeaNJB-SHYFIIsvtw6VUn0",
      authDomain: "discord-lite-98386.firebaseapp.com",
      databaseURL: "https://discord-lite-98386-default-rtdb.firebaseio.com",
      projectId: "discord-lite-98386",
      storageBucket: "discord-lite-98386.firebasestorage.app",
      messagingSenderId: "247147523999",
      appId: "1:247147523999:web:51ebcf1d1575f80ee257aa",
      measurementId: "G-YZ5VD42XVV"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null;
    let currentPfp = null;
    let currentChannel = "general";

    function defaultPfpDataUrl(letter) {
      const svg =
        '<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64">' +
        '<rect width="64" height="64" fill="#3a3c43"/>' +
        '<text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#b9bbbe" font-size="26" font-family="Arial">' +
        letter +
        "</text></svg>";
      return "data:image/svg+xml;base64," + btoa(svg);
    }

    function applyUserToUI() {
      const nameEl = document.getElementById("user-name");
      if (nameEl && currentUser) nameEl.textContent = currentUser;

      const pfpEl = document.getElementById("user-pfp");
      if (pfpEl) {
        if (currentPfp) {
          pfpEl.src = currentPfp;
        } else {
          const letter = currentUser ? currentUser.charAt(0).toUpperCase() : "U";
          pfpEl.src = defaultPfpDataUrl(letter);
        }
      }
    }

    function appendMessage(msg) {
      const messagesDiv = document.getElementById("messages");

      const row = document.createElement("div");
      row.className = "message-row";

      const pfpImg = document.createElement("img");
      pfpImg.className = "message-pfp";
      if (msg.pfp) {
        pfpImg.src = msg.pfp;
      } else {
        const letter = msg.user ? msg.user.charAt(0).toUpperCase() : "U";
        pfpImg.src = defaultPfpDataUrl(letter);
      }

      const content = document.createElement("div");
      content.className = "message-content";

      const nameSpan = document.createElement("span");
      nameSpan.className = "message-username";
      nameSpan.textContent = msg.user || "User";

      const textSpan = document.createElement("span");
      textSpan.className = "message-text";
      textSpan.textContent = msg.text || "";

      content.appendChild(nameSpan);
      content.appendChild(textSpan);

      row.appendChild(pfpImg);
      row.appendChild(content);

      messagesDiv.appendChild(row);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function loadMessagesForChannel(channel) {
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML = "";

      db.ref("messages/" + channel).off(); // remove old listener

      db.ref("messages/" + channel).on("value", (snapshot) => {
        const data = snapshot.val();
        messagesDiv.innerHTML = "";
        if (!data) return;

        const list = Object.values(data);
        list.forEach((msg) => appendMessage(msg));
      });
    }

    function sendMessage() {
      const input = document.getElementById("message-input");
      const text = input.value.trim();
      if (!text || !currentUser) return;

      const msgObj = {
        user: currentUser,
        text: text,
        pfp: currentPfp || null,
        ts: Date.now()
      };

      db.ref("messages/" + currentChannel).push(msgObj);
      input.value = "";
    }

    function openSettings() {
      document.getElementById("settings-overlay").style.display = "flex";
    }

    function closeSettings() {
      document.getElementById("settings-overlay").style.display = "none";
    }

    function applySettingsFromStorage() {
      const bgColor = localStorage.getItem("dl_bgColor");
      const dmPref = localStorage.getItem("dl_dmPref");
      const pfp = localStorage.getItem("dl_pfp");

      if (bgColor) {
        document.body.style.backgroundColor = bgColor;
        const picker = document.getElementById("bg-picker");
        if (picker) picker.value = bgColor;
      }

      if (dmPref) {
        const sel = document.getElementById("dm-pref");
        if (sel) sel.value = dmPref;
      }

      currentPfp = pfp || null;
      applyUserToUI();
    }

    function saveSettings() {
      const bgPicker = document.getElementById("bg-picker");
      const dmPrefSel = document.getElementById("dm-pref");
      const pfpInput = document.getElementById("pfp-input");

      if (bgPicker && bgPicker.value) {
        localStorage.setItem("dl_bgColor", bgPicker.value);
      }

      if (dmPrefSel && dmPrefSel.value) {
        localStorage.setItem("dl_dmPref", dmPrefSel.value);
      }

      const file = pfpInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          localStorage.setItem("dl_pfp", e.target.result);
          currentPfp = e.target.result;
          applySettingsFromStorage();
          closeSettings();
        };
        reader.readAsDataURL(file);
      } else {
        applySettingsFromStorage();
        closeSettings();
      }
    }

    function handleLogin() {
      const uInput = document.getElementById("login-username");
      const pInput = document.getElementById("login-password");
      const name = (uInput.value || "").trim();
      const pass = (pInput.value || "").trim();

      if (!name) return;

      currentUser = name;
      localStorage.setItem("dl_username", currentUser);
      localStorage.setItem("dl_password", pass);

      document.getElementById("login-overlay").style.display = "none";
      applyUserToUI();
      loadMessagesForChannel(currentChannel);
    }

    // ALWAYS show login on startup
    function initUserFromStorage() {
      document.getElementById("login-overlay").style.display = "flex";

      // clear any old auto-login data so it never skips
      localStorage.removeItem("dl_username");
      localStorage.removeItem("dl_password");

      applyUserToUI();
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Init user + settings
      initUserFromStorage();
      applySettingsFromStorage();

      // Channels
      document.querySelectorAll(".channel").forEach((el) => {
        el.addEventListener("click", () => {
          currentChannel = el.getAttribute("data-channel") || "general";
          document.getElementById("header").textContent = "#" + currentChannel;
          loadMessagesForChannel(currentChannel);
        });
      });

      // Initial messages load (will show once logged in)
      loadMessagesForChannel(currentChannel);

      // Send message
      document.getElementById("send-button").addEventListener("click", sendMessage);
      document.getElementById("message-input").addEventListener("keydown", (e) => {
        if (e.key === "Enter") sendMessage();
      });

      // Login
      document.getElementById("login-button").addEventListener("click", handleLogin);
      document.getElementById("login-username").addEventListener("keydown", (e) => {
        if (e.key === "Enter") handleLogin();
      });
      document.getElementById("login-password").addEventListener("keydown", (e) => {
        if (e.key === "Enter") handleLogin();
      });

      // Settings
      document.getElementById("settings-icon").addEventListener("click", openSettings);
      document.getElementById("settings-close").addEventListener("click", closeSettings);
      document.getElementById("settings-overlay").addEventListener("click", (e) => {
        if (e.target.id === "settings-overlay") closeSettings();
      });
      document.getElementById("settings-save").addEventListener("click", saveSettings);

      // Add friend (simple local list)
      document.getElementById("add-friend-button").addEventListener("click", () => {
        const input = document.getElementById("add-friend-input");
        const name = (input.value || "").trim();
        if (!name) return;
        const list = document.getElementById("friends-list");
        const div = document.createElement("div");
        div.className = "friend";
        div.textContent = name;
        list.appendChild(div);
        input.value = "";
      });
    });
  </script>
</body>
</html>
